<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0"> 
  <title>Little Artix</title>
  <link rel="icon" type="image/x-icon" href="../images/finals_logo.ico">
  <link rel="stylesheet" href="order.css">
  
</head>
<body>
  <div class="navbar">
    <a href="#" class="logo">Little Artix <img src="../images/finals_logo.png" alt="Logo"></a>
    <ul class="nav">
      <li><a href="../index.html">Home</a></li>
      <li><a href="about.html">About</a></li>
      <li><a href="products.html">Products</a></li>
      <li><a href="services.html">Services</a></li>
      <li><a href="contact.html">Contact</a></li>
      <li><a href="reviews.html">Reviews</a></li>
      <li><a href="order.php">Pre-Order</a></li>
    </ul>
  </div>
  
  <div class="content">
    <h1>Verification Process</h1>
    <p>An email with a six-digit verification code has been sent to your email address. Enter the code below to proceed.</p>

    <?php if (!empty($errorMessage)) { ?>
      <p style="color: red;"><?php echo $errorMessage; ?></p>
    <?php } ?>

    <form method="post">

    <?php
      // Start the session (if not already started)
      session_start();

      // Check if the user email is stored in the session
      if (isset($_SESSION["userEmail"])) {
        $email = $_SESSION["userEmail"];
      } else {
        // Redirect to feedback page if email is not found in session (unusual case)
        header("Location: feedback_nobs.php");
        exit;
      }
      ?>
      <input type="hidden" name="email" value="<?php echo $email; ?>"> <div class="code-input">

      <div class="code-input">
        <input type="text" maxlength="1" name="code" class="digit">
        <input type="text" maxlength="1" name="code"class="digit">
        <input type="text" maxlength="1" name="code"class="digit">
        <input type="text" maxlength="1" name="code" class="digit">
        <input type="text" maxlength="1" name="code" class="digit">
        <input type="text" maxlength="1" name="code" class="digit">
      </div>
      <button type="submit">Submit</button>
    </form>
    <?php

    // Database connection details (replace with your actual details)
    $servername = "localhost";
    $username = "root";
    $password = "";
    $dbname = "feedback";

    $conn = mysqli_connect($servername, $username, $password, $dbname);

    // Check connection
    if (!$conn) {
      die("Connection failed: " . mysqli_connect_error());
    }

    if ($_SERVER["REQUEST_METHOD"] == "POST") {
      $enteredCode = $_POST["code"]; // Assuming all form field names have name="code"
      $email = $_POST["email"]; // Assuming the hidden field name is "email"

      // Escape the user input to prevent SQL injection attacks
      $email = mysqli_real_escape_string($conn, $email); // Assuming a hidden field with user email

      $sql = "SELECT verification_code FROM storedfeedbacks WHERE email = '$email' AND used = 0";
      $result = $conn->query($sql);

      if ($result->num_rows > 0) {
        $row = $result->fetch_assoc();
        $recordedCode = $row["verification_code"];

        // Compare entered code with recorded code (using password_verify for security)
        if (password_verify($enteredCode, $recordedCode)) {
          // Codes match, verification successful!
          echo "<h3>Verification successful!</h3>"; // Handle successful verification

          // Update the code as used in the database (optional)
          $sql = "UPDATE storedfeedbacks SET used = 1 WHERE email = '$email' AND verification_code = '$recordedCode'";
          $conn->query($sql);
        } else {
          // Codes don't match, display error message
          $errorMessage = "Invalid verification code.";
        }
      } else {
        // No record found for the user's email or code already used
        $errorMessage = "Invalid verification code or email.";
      }
    }

    $conn->close();

    ?>
  </div>

  <footer>
    <div class="footer-content">
      <ul class="nav">
        <li><a href="#disclaimer">Disclaimer</a></li>
        <li><a href="#termsandcondition">Terms and conditions</a></li>
        <li><a href="#privacy policy">Privacy policy</a></li>
      </ul>
    </div>
  </footer>
</body>
</html>
<?php
/*<?php
  use PHPMailer\PHPMailer\PHPMailer;
  use PHPMailer\PHPMailer\Exception;
  use PHPMailer\PHPMailer\SMTP;

require 'PHPMailer-master/src/PHPMailer.php';
require 'PHPMailer-master/src/SMTP.php';
require 'PHPMailer-master/src/Exception.php';

    // Replace with your actual database credentials (use environment variables for security)
    $servername = "localhost";
    $username = "root";
    $password = "";
    $database = "feedback";

    function connectToDatabase() {
      global $servername, $username, $password, $database;
      $conn = mysqli_connect($servername, $username, $password, $database);
      if (!$conn) {
        die("Connection failed: " . mysqli_connect_error());
      }
      return $conn;
    }

    if ($_SERVER["REQUEST_METHOD"] == "POST") {
      $email = $_POST["email"];
      $feedback = $_POST["feedback"];

      $conn = connectToDatabase();

      // Sanitize email before inserting
      $sanitizedEmail = mysqli_real_escape_string($conn, $email);
      $verificationCode = rand(100000, 999999);

      $sql = "INSERT INTO `storedfeedbacks` (`s.no`,`email`, `feedback`,`verification_code`, `timestamp`) VALUES (NULL,'$sanitizedEmail','$feedback','$verificationCode', current_timestamp())";
      $result = mysqli_query($conn, $sql);

      if ($result) {
       // $verificationCode = rand(100000, 999999);

       // $sql = "INSERT INTO storedfeedbacks (verification_code) VALUES ('$verificationCode')";
      // mysqli_query($conn, $sql);

         $mail = new PHPMailer(true); // Enable exceptions

        try {
       

          // Replace with your SMTP details (use environment variables for security)
          $mail->SMTPDebug = SMTP::DEBUG_SERVER; 
          $mail->isSMTP();
          $mail->Host = 'smtp.gmail.com';
          $mail->Port = 587; // Typically 587 for TLS, 465 for SSL
          $mail->SMTPSecure = 'tsl'; // or 'ssl'
          $mail->SMTPAuth = true;
          $mail->Username = 'roanremetre00@gmail.com';
          $mail->Password = 'qzuc xkuq yhbs pymp';

          $mail->SMTPSecure = PHPMailer::ENCRYPTION_STARTTLS;         // Enable TLS encryption; `PHPMailer::ENCRYPTION_SMTPS` for SSL
          $mail->SMTPOptions = array(
          'ssl' => array(
          'verify_peer' => false,
          'verify_host' => false,
          'allow_self_signed' => true
            )
          );

          $mail->setFrom('roanremetre00@gmail.com', 'Little Artix Feedback');
          $mail->addAddress($sanitizedEmail);
          $mail->Subject = 'Little Artix Feedback Verification';

          // Set email content to plain text
          $mail->Body = "Your verification code for Little Artix feedback is: $verificationCode";
          $mail->isHTML(false);
          $mail->send();
          echo '<div class="alert alert-success">Verification code sent to your email!</div>';
        } catch (Exception $e) {
          // Handle specific exceptions for better error messages
          if (strpos($e->getMessage(), 'Failed to connect to mail server')) {
            $errorMessage = 'Failed to connect to email server. Please check your network connection or SMTP settings.';
          } else if (strpos($e->getMessage(), 'Invalid credentials')) {
            $errorMessage = 'Invalid email credentials. Please verify your username and password.';
          } else {
            $errorMessage = 'Error sending verification code: ' . $e->getMessage();
          }
          echo "<div class='alert alert-danger'>$errorMessage</div>";
        }
      } else {
        echo '<div class="alert alert-warning alert-dismissible fade show" role"alert" <strong>Erroruploading data</strong></div>' . mysqli_error($conn);
      }

      mysqli_close($conn);
    }
  ?> */